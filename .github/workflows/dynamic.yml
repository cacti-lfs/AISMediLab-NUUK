# ===========================================================
# METADONNÃ‰ES
# ===========================================================
name: "TF/Ans. 'Dynamic' 'Dynamic'"
run-name: "TF/Ans. 'Dynamic' pour ${{ github.ref_name }}"

# ===========================================================
# DÃ‰CLENCHEURS
# ===========================================================
on:
  push:
    branches: [main, feature]
    paths: ['terraform/**', '.github/workflows/*']
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement cible pour ce Build"
        required: true
        type: choice
        options: [poc, nuuk]
        default: poc

      # --- Ã‰TAPE TERRAFORM ---
      run_terraform:
        description: "ExÃ©cution Terraform"
        type: boolean
        default: false

      terarform_action:
        description: "Action (si Terraform activÃ©)"
        type: choice
        options: [deploy, destroy, recreate]
        default: deploy

      # --- Ã‰TAPE ANSIBLE ---
      run_ansible:
        description: "ExÃ©cution Ansible"
        type: boolean
        default: true

      # --- SÃ‰LECTTION DES COMPOSANTS ---
      target_scope:
        description: "Composants cibles"
        type: choice
        options: [Tous, SÃ©lection]
        default: SÃ©lection

      deploy_dhcp:
        description: "DHCP"
        type: boolean
        default: false


# ===========================================================
# PERMISSIONS
# ===========================================================
permissions:
  contents: read

# ===========================================================
# CONFIGURATION GLOBALE
# ===========================================================
env:
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}

# ===========================================================
# JOBS (UnitÃ©s de travai)
# ===========================================================
jobs:
  # =========================================================
  # JOB POUR LE POC
  # =========================================================
  job-dhcp:
    name: "Terraform Dynamic POC"
    if: |
      github.event_name == 'push' || 
      github.event.inputs.target_scope == 'Tous' || 
      github.event.inputs.deploy_dhcp == 'true'
    runs-on: [self-hosted, poc-runner]
    environment: ${{ github.event.inputs.environment }}
    env: 
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_proxmox_api_user: ${{ secrets.PVE_API_USER }}
      TF_VAR_proxmox_api_token_id: ${{ secrets.PVE_TOKEN_ID }}
      TF_VAR_proxmox_api_token_secret: ${{ secrets.PVE_TOKEN_SECRET }}
      TF_VAR_ip_dhcp_01: ${{ vars.TF_IP_DHCP_01 }}
      TF_VAR_ip_dhcp_02: ${{ vars.TF_IP_DHCP_02 }}
      TF_VAR_gateway_vlan70: ${{ vars.TF_GATEWAY_VLAN70 }}
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}
      TF_VAR_ip_node_1: ${{ vars.TF_IP_NODE_1 }}
      TF_VAR_ip_node_2: ${{ vars.TF_IP_NODE_2 }}
      TF_VAR_ssh_public_keys: |
        ${{ vars.SSH_PUBLIC_KEYS }}
      TF_WORKSPACE: "nuuk-medilab-poc"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_VAR_environnement: "poc"
      TF_VAR_full_clone: "false"
      TF_CLOUD_ORGANIZATION: "nuuk"

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      # ================================================================
      # SECTION TERRAFORM (Conditionnelle selon l'input "run_terraform")
      # ================================================================
      # 1. VÃ©rification du formatage
      # - name: Check Terraform Formatting
      #   run: terraform -chdir=terraform/composants/02_dhcp fmt -check
      
        # 2. Initialisation
      - name: Terraform Init (02_dhcp)
        if: github.event_name == 'push' || inputs.run_terraform
        run: terraform -chdir=terraform/composants/02_dhcp init -upgrade

      # 3. Validation de la syntaxe
      - name: Terraform Validate (02_dhcp)
        if: github.event_name == 'push' || inputs.run_terraform
        run: terraform -chdir=terraform/composants/02_dhcp validate
      
      # 4. Analyse de sÃ©curitÃ© avec tfsec
      # - name: tfsec Check
      #   uses: aquasecurity/tfsec-action@v1.0.0  
      #   with:
      #     working_directory: terraform/composants/02_dhcp
      #     soft_fail: false # Pipeline Ã©chouera si des problÃ¨mes de sÃ©curitÃ© sont dÃ©tectÃ©s
      # Step de destruction conditionnelle
      - name: Terraform Destroy (Recreate mode ou Destroy mode)
      # Se lance si run_terraform=true ET action=recreate ou destroy
        if: >-
          (github.event_name == 'push' || github.event.inputs.run_terraform == 'true') && 
          (github.event.inputs.terarform_action == 'destroy' || github.event.inputs.terarform_action == 'recreate')
        run: terraform -chdir=terraform/composants/02_dhcp destroy -auto-approve
      
      - name: Proxmox Clean Urgence (API Timeout)
        if: failure()
        shell: bash
        run: |
          echo "ðŸš¨ Erreur API dÃ©tectÃ©e. Nettoyage manuel des verrous et rÃ©sidus..."

          export SSH_AUTH_SOCK=$SSH_AUTH_SOCK
          ssh -o StrictHostKeyChecking=no -o BatchMode=yes root@192.168.1.251 "qm stop 701 || true"
          ssh -o StrictHostKeyChecking=no -o BatchMode=yes root@192.168.1.252 "qm stop 702 || true"
      # 5. Plan
      - name: Terraform Plan (02_dhcp)
        if: >-
          (github.event_name == 'push' || github.event.inputs.run_terraform == 'true') && 
          (github.event.inputs.terarform_action == 'deploy' || github.event.inputs.terarform_action == 'recreate')
        run: terraform -chdir=terraform/composants/02_dhcp plan
      # 6. Apply
      - name: Terraform Apply (02_dhcp)
        if: >-
          (github.event_name == 'push' || github.event.inputs.run_terraform == 'true') && 
          (github.event.inputs.terarform_action == 'deploy' || github.event.inputs.terarform_action == 'recreate')
        run: terraform -chdir=terraform/composants/02_dhcp apply -auto-approve -parallelism=1

      # ================================================================
      # SECTION ANSIBLE (Conditionnelle par run_ansible)
      # ================================================================


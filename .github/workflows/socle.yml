# ===========================================================
# METADONN√âES
# ===========================================================
name: "D√©ploiement Terraform 'Socle'"
run-name: "D√©ploiement Terraform 'Socle' pour ${{ github.ref_name }}"

# ===========================================================
# D√âCLENCHEURS
# ===========================================================
on:
  push:
    branches: [main,feature]
    paths: ['terraform/**', '.github/workflows/*']
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement cible"
        required: true
        type: choice
        options: [poc, nuuk, all]
      run_terraform:
        description: "Activer la partie Terraform ?"
        required: true
        type: boolean
        default: false
      terraform_action:
        description: "Action Terraform (si activ√©)"
        required: false
        type: choice
        options: [deploy, recreate, destroy]
        default: deploy
      run_ansible:
        description: "Activer la partie Ansible ?"
        required: true
        type: boolean
        default: true

# ===========================================================
# PERMISSIONS
# ===========================================================
permissions: # Principe du moindre privil√®ge
  contents: read

# ===========================================================
# CONFIGURATION GLOBALE
# ===========================================================
env:
  TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}

# ===========================================================
# JOBS (Unit√©s de travai)
# ===========================================================
jobs:
  # =========================================================
  # JOB POUR LE POC
  # =========================================================
  deploy-terra-static-poc:
    name: "Terraform Static POC"
    if: github.event.inputs.environment == 'poc' || github.event.inputs.environment == 'all' || github.event_name == 'push'
    runs-on: [self-hosted, poc-runner]
    environment: poc # Utilise les secrets de "poc"
    env: 
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_proxmox_api_user: ${{ secrets.PVE_API_USER }}
      TF_VAR_proxmox_api_token_id: ${{ secrets.PVE_TOKEN_ID }}
      TF_VAR_proxmox_api_token_secret: ${{ secrets.PVE_TOKEN_SECRET }}
      TF_VAR_ip_bastion_01: ${{ vars.TF_IP_BASTION_01 }}
      TF_VAR_ip_bastion_02: ${{ vars.TF_IP_BASTION_02 }}
      TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
      TF_VAR_gateway_vlan40: ${{ vars.TF_GATEWAY_VLAN40 }}
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}
      TF_VAR_ip_node_1: ${{ vars.TF_IP_NODE_1 }}
      TF_VAR_ip_node_2: ${{ vars.TF_IP_NODE_2 }}
      TF_VAR_ssh_public_keys: |
        ${{ vars.SSH_PUBLIC_KEYS }}
      TF_WORKSPACE: "nuuk-medilab-poc"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_VAR_environnement: "poc"
      TF_VAR_full_clone: "false"
      TF_CLOUD_ORGANIZATION: "nuuk"

    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      
      # ================================================================
      # SECTION TERRAFORM (Conditionnelle selon l'input "run_terraform")
      # ================================================================
      # 1. V√©rification du formatage
      # - name: Check Terraform Formatting
      #   run: terraform -chdir=terraform/composants/01_bastion fmt -check
      
        # 2. Initialisation
      - name: Terraform Init (01_bastion)
        if: github.event_name == 'push' || inputs.run_terraform
        run: terraform -chdir=terraform/composants/01_bastion init -upgrade

      # 3. Validation de la syntaxe
      - name: Terraform Validate (01_bastion)
        if: github.event_name == 'push' || inputs.run_terraform
        run: terraform -chdir=terraform/composants/01_bastion validate
      
      # 4. Analyse de s√©curit√© avec tfsec
      # - name: tfsec Check
      #   uses: aquasecurity/tfsec-action@v1.0.0  
      #   with:
      #     working_directory: terraform/composants/01_bastion
      #     soft_fail: false # Pipeline √©chouera si des probl√®mes de s√©curit√© sont d√©tect√©s
      # Step de destruction conditionnelle
      - name: Terraform Destroy (Recreate mode ou Destroy mode)
      # Se lance si run_terraform=true ET action=recreate ou destroy
        if: (github.event_name == 'push' || inputs.run_terraform) && (github.event.inputs.action != 'apply')
        run: terraform -chdir=terraform/composants/01_bastion destroy -auto-approve
      
      - name: Proxmox Clean Urgence (API Timeout)
        if: failure()
        run: |
          echo "üö® Erreur API d√©tect√©e. Nettoyage manuel des verrous et r√©sidus..."
          
          # Utilisation des variables d'inventaire
          NODES="${{ vars.TF_IP_NODE_1 }} ${{ vars.TF_IP_NODE_2 }}"
          VM_LIST="401 402"

          for node in $NODES; do
            echo "--- Connexion √† $node ---"
            for id in $VM_LIST; do
              # On passe les commandes en une seule fois pour plus de rapidit√©
              ssh -o StrictHostKeyChecking=no root@$node "
                echo 'V√©rification VM $id...'
                # Arr√™t forc√© et suppression du lock Proxmox
                qm stop $id --skiplock 2>/dev/null || true
                
                # Suppression propre du fichier de conf si Terraform a laiss√© des traces
                if [ -f /etc/pve/qemu-server/$id.conf ]; then
                  echo 'Suppression du fichier de config $id.conf'
                  rm -f /etc/pve/qemu-server/$id.conf
                fi

                # Nettoyage des volumes ZFS orphelins
                echo 'Recherche de disques ZFS pour la VM $id...'
                zfs list -H -o name | grep \"vm-$id-disk\" | xargs -n1 zfs destroy -r 2>/dev/null || true
              "
            done
          done
      # 5. Plan
      - name: Terraform Plan (01_bastion)
        if: (github.event_name == 'push' || inputs.run_terraform) && (github.event.inputs.action != 'destroy')
        run: terraform -chdir=terraform/composants/01_bastion plan
      # 6. Apply
      - name: Terraform Apply (01_bastion)
        if: (github.event_name == 'push' || inputs.run_terraform) && (github.event.inputs.action != 'destroy')
        run: terraform -chdir=terraform/composants/01_bastion apply -auto-approve -parallelism=1

      # ================================================================
      # SECTION ANSIBLE (Conditionnelle par run_ansible)
      # ================================================================

      # Ajout de la clef SSH dans le Runner
      - name: Add SSH Key to Runner
        if: github.event_name == 'push' || inputs.run_ansible
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Ping Ansible
        if: github.event_name == 'push' || inputs.run_ansible
        run: |
          export ANSIBLE_HOST_KEY_CHECKING=False
          if [[ "${{ github.event.inputs.run_terraform }}" == "true" ]]; then sleep 30; fi

          ansible -i ansible/inventory/inventory.proxmox.yml 'DEB-BAST*' \
            -m ping \
            -u cloudadm
#            -e "ansible_ssh_common_args='-o StrictHostKeyChecking=no'"

      # Step lancement Ansible inventory
      - name: Lancement Ansible Inventaire
        if: github.event_name == 'push' || inputs.run_ansible
        run: ansible-inventory -i ansible/inventory/inventory.proxmox.yml --graph

      # Step lancement Ansible Playbook
      - name: Lancement Ansible Playbook
        if: github.event_name == 'push' || inputs.run_ansible
        run: ansible-playbook -i ansible/inventory/inventory.proxmox.yml ansible/playbooks/bastion.yml

      # Step Etat de r√©ussite ou d'√©chec du pipeline

      
  # =========================================================
  # JOB POUR NUUK
  # =========================================================
  deploy-terra-static-nuuk:
    name: "Terraform Static Nuuk"
    if: false && (github.event.inputs.environment == 'nuuk' || github.event.inputs.environment == 'all' || github.event_name == 'push') 
    # D√©sactiv√© pour √©viter les d√©ploiements accidentels sur l'environnement de production
    runs-on: [self-hosted, nuuk-runner]
    environment: nuuk # Utilise les secrets de "nuuk"
    env: 
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_ip_bastion_01: ${{ vars.TF_IP_BASTION_01 }}
      TF_VAR_ip_bastion_02: ${{ vars.TF_IP_BASTION_02 }}
      TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
      TF_VAR_gateway_vlan40: ${{ vars.TF_GATEWAY_VLAN40 }}
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}
      TF_VAR_ssh_public_keys: |
        ${{ vars.SSH_PUBLIC_KEYS }}
      TF_WORKSPACE: "nuuk-medilab-prod"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_CLOUD_ORGANIZATION: "nuuk"
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
      # Init
      - name: Terraform Init (01_bastion)
        run: terraform -chdir=terraform/composants/01_bastion init

      # Step de destruction conditionnelle
      - name: Terraform Destroy (Recreate mode)
        if: ${{ github.event.inputs.action == 'recreate' }}
        run: terraform -chdir=terraform/composants/01_bastion destroy -auto-approve
      # Plan
      - name: Terraform Plan (01_bastion)
        run: terraform -chdir=terraform/composants/01_bastion plan
      # Apply
      - name: Terraform Apply (01_bastion)
        run: terraform -chdir=terraform/composants/01_bastion apply -auto-approve -parallelism=1
      
      # Step de destruction de l'infra
      - name: Terraform Destroy (Destroy mode)
        if: ${{ github.event.inputs.action == 'destroy' }}
        run: terraform -chdir=terraform/composants/01_bastion destroy -auto-approve

    # =========================================================
    # JOBS POUR LES AUTRES ENVIRONNEMENTS (ex: staging) √Ä VENIR
    # =========================================================
  terraform-deploy:
    # Test de Job unique
    name: "Deploy to ${{ matrix.target_env }}"
    if: false && (github.event.inputs.environment == 'all' || github.event_name == 'push')
    runs-on: ${{ matrix.target_env == 'nuuk' && 'nuuk-runner' || 'poc-runner' }}
    
    # Matrice pour g√©rer les diff√©rents environnements
    strategy:
      fail-fast: true
      matrix:
        target_env: [poc, nuuk]

    # Chargement des variables dans l'environnement courant du job
    environment: ${{ matrix.target_env }}

    env: 
      # Variables d'acc√®s
      TF_VAR_proxmox_api_url: ${{ vars.PVE_API_URL }}
      # Variables sp√©cifiques √† l'infrastructure
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}

      # Variables de configuration r√©seau
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}
      TF_VAR_gateway_vlan40: ${{ vars.TF_GATEWAY_VLAN40 }}
      TF_VAR_ip_bastion_01: ${{ vars.TF_IP_BASTION_01 }}
      TF_VAR_ip_bastion_02: ${{ vars.TF_IP_BASTION_02 }}
      TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}

      # S√©curit√© & Workspace
      TF_VAR_ssh_public_keys: ${{ vars.SSH_PUBLIC_KEYS }}
      TF_WORKSPACE: "nuuk-medilab-${{ matrix.target_env }}"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_CLOUD_ORGANIZATION: "nuuk"
      TF_VAR_full_clone: "false"

    steps:
      - uses: actions/checkout@v4
      
      - name: Terraform Init
        run: terraform -chdir=terraform/composants/01_bastion init -upgrade

      - name: Terraform Plan
        run: terraform -chdir=terraform/composants/01_bastion plan

      - name: Terraform Apply
        # apply manuel obligatoire
        if: github.ref == 'refs/heads/main'
        run: terraform -chdir=terraform/composants/01_bastion apply -auto-approve
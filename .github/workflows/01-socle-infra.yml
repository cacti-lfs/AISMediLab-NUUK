name: "01. Socle - Infrastructure"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement (poc ou nuuk)"
        required: true
        type: choice
        options: [poc, nuuk]
      deploy_bastion:
        description: "D√©ployer le composant Bastion ?"
        type: boolean
        default: true
      deploy_dhcp:
        description: "D√©ployer le composant DHCP (VLAN 70) ?"
        type: boolean
        default: true
      terraform_action:
        description: "Action Terraform"
        type: choice
        options: [apply, plan, destroy]
        default: apply

jobs:
  provisioning:
    name: "Socle Infrastructure"
    runs-on: [self-hosted, poc-runner]
    environment: ${{ github.event.inputs.environment }}

    env:
      # --- COMMUN ---
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_CLOUD_ORGANIZATION: "nuuk"
      ANSIBLE_HOST_KEY_CHECKING: "False"
      BASTION_PASS: ${{ secrets.BASTION_PASS }}
      
      # --- TERRAFORM VARS (Shared) ---
      TF_VAR_environnement: ${{ github.event.inputs.environment }}
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_proxmox_api_user: ${{ secrets.PVE_API_USER }}
      TF_VAR_proxmox_api_token_id: ${{ secrets.PVE_TOKEN_ID }}
      TF_VAR_proxmox_api_token_secret: ${{ secrets.PVE_TOKEN_SECRET }}
      TF_VAR_ssh_public_keys: "${{ vars.SSH_PUBLIC_KEYS }}"
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}
      TF_VAR_ip_node_1: ${{ vars.TF_IP_NODE_1 }}
      TF_VAR_ip_node_2: ${{ vars.TF_IP_NODE_2 }}
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup Python (Ansible)
        uses: actions/setup-python@v5
        with:
          python-version: '3.12.12'

      - name: Install Ansible dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core community.proxmox

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ============================================================
      # BLOC 01 : BASTIONS (VLAN 40)
      # ============================================================
      - name: Terraform Bastion (Action)
        if: github.event.inputs.deploy_bastion == 'true'
        env:
          TF_WORKSPACE: "nuuk-medilab-${{ github.event.inputs.environment }}-01-bastion"
          TF_VAR_ip_bastion_01: ${{ vars.TF_IP_BASTION_01 }}
          TF_VAR_ip_bastion_02: ${{ vars.TF_IP_BASTION_02 }}
          TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
          TF_VAR_gateway_vlan40: ${{ vars.TF_GATEWAY_VLAN40 }}
        run: |
          terraform -chdir=terraform/composants/01_bastion init
          terraform -chdir=terraform/composants/01_bastion ${{ github.event.inputs.terraform_action }} -auto-approve -parallelism=1

      - name: Auto-Healing Proxmox Bastion (si fail)
        if: failure() && github.event.inputs.deploy_bastion == 'true'
        run: |
          echo "üö® Nettoyage des verrous Bastions sur Node 1 et Node 2..."
          ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_1 }} "qm unlock 401 || true"
          ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_2 }} "qm unlock 402 || true"

      - name: Healthcheck Bastion
        if: success() && github.event.inputs.deploy_bastion == 'true' && github.event.inputs.terraform_action == 'apply'
        run: |
          for IP in "${{ vars.TF_IP_BASTION_01 }}" "${{ vars.TF_IP_BASTION_02 }}"; do
            timeout 120s bash -c "until ping -c 1 -W 1 $IP > /dev/null; do sleep 5; done"
            timeout 60s bash -c "until nc -zvw1 $IP 22; do sleep 5; done"
            echo "‚úÖ Bastion $IP est pr√™t."
          done

      - name: Ansible Bastion
        if: success() && github.event.inputs.deploy_bastion == 'true' && github.event.inputs.terraform_action == 'apply'
        run: |
          cd ansible
          ansible-playbook 01_deploy_bastions.yml -u cloudadm

      # ============================================================
      # BLOC 02 : DHCP (VLAN 70)
      # ============================================================
      - name: Terraform DHCP (Action)
        if: github.event.inputs.deploy_dhcp == 'true'
        env:
          TF_WORKSPACE: "nuuk-medilab-${{ github.event.inputs.environment }}-02-core-infra"
          TF_VAR_ip_dhcp_01: ${{ vars.TF_IP_DHCP_01 }}
          TF_VAR_ip_dhcp_02: ${{ vars.TF_IP_DHCP_02 }}
          TF_VAR_gateway_vlan70: ${{ vars.TF_GATEWAY_VLAN70 }}
        run: |
          terraform -chdir=terraform/composants/02_core_infra init
          terraform -chdir=terraform/composants/02_core_infra ${{ github.event.inputs.terraform_action }} -auto-approve -parallelism=1

      - name: Auto-Healing Proxmox DHCP (si fail)
        if: failure() && github.event.inputs.deploy_dhcp == 'true'
        run: |
          echo "üö® Nettoyage des verrous DHCP sur Node 1 et Node 2..."
          ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_1 }} "qm unlock 701 || true"
          ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_2 }} "qm unlock 702 || true"

      - name: Healthcheck DHCP (Via Bastion)
        if: success() && github.event.inputs.deploy_dhcp == 'true' && github.event.inputs.terraform_action == 'apply'
        run: |
          # On teste l'accessibilit√© via le runner (si routage OK) ou via SSH simple
          for IP in "${{ vars.TF_IP_DHCP_01 }}" "${{ vars.TF_IP_DHCP_02 }}"; do
            echo "‚è≥ Attente du DHCP $IP..."
            timeout 120s bash -c "until nc -zvw1 $IP 22; do sleep 5; done"
            echo "‚úÖ DHCP $IP est pr√™t pour Ansible."
          done

      - name: Ansible DHCP
        if: success() && github.event.inputs.deploy_dhcp == 'true' && github.event.inputs.terraform_action == 'apply'
        env:
          TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
          TF_VAR_ip_dhcp_vip: ${{ vars.TF_IP_DHCP_VIP }}
        run: |
          cd ansible
          ansible-playbook 02_deploy_dhcp.yml -u cloudadm
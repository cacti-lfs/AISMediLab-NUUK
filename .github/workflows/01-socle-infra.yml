name: "01. Socle - DÃ©ploiement Bastion"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement (poc ou nuuk)"
        required: true
        type: choice
        options: [poc, nuuk]
      run_terraform:
        description: "ExÃ©cuter Terraform ?"
        type: boolean
        default: true
      terraform_action:
        description: "Action Terraform"
        type: choice
        options: [apply, plan, destroy]
        default: apply
      run_ansible:
        description: "ExÃ©cuter Ansible ?"
        type: boolean
        default: true

jobs:
  deploy:
    name: "Provisionnement & Configuration"
    runs-on: [self-hosted, poc-runner]
    environment: ${{ github.event.inputs.environment }}

    env:
      # --- TERRAFORM VARS ---
      TF_WORKSPACE: "nuuk-medilab-${{ github.event.inputs.environment }}-01-bastion"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_CLOUD_ORGANIZATION: "nuuk"
      TF_VAR_environnement: ${{ github.event.inputs.environment }}
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_proxmox_api_user: ${{ secrets.PVE_API_USER }}
      TF_VAR_proxmox_api_token_id: ${{ secrets.PVE_TOKEN_ID }}
      TF_VAR_proxmox_api_token_secret: ${{ secrets.PVE_TOKEN_SECRET }}
      TF_VAR_ip_bastion_01: ${{ vars.TF_IP_BASTION_01 }}
      TF_VAR_ip_bastion_02: ${{ vars.TF_IP_BASTION_02 }}
      TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
      TF_VAR_gateway_vlan40: ${{ vars.TF_GATEWAY_VLAN40 }}
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}
      TF_VAR_ssh_public_keys: |
        ${{ vars.SSH_PUBLIC_KEYS }}
      
      # --- ANSIBLE / SHARED VARS ---
      BASTION_IFACE: ${{ vars.BASTION_IFACE }}
      BASTION_PASS: ${{ secrets.BASTION_PASS }}
      BASTION_ROUTER_ID: ${{ vars.BASTION_ROUTER_ID }}
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - uses: actions/checkout@v4

      - name: Add SSH Key to Runner
        uses: webfactory/ssh-agent@a6f90b1f127823b31d4d4a8d96047790581349bd # v0.9.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      # ==========================================
      # SECTION TERRAFORM
      # ==========================================
      - name: Setup Terraform
        if: github.event.inputs.run_terraform == 'true'
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        if: github.event.inputs.run_terraform == 'true'
        run: terraform -chdir=terraform/composants/01_bastion init

      - name: Terraform Action
        if: github.event.inputs.run_terraform == 'true'
        run: |
          terraform -chdir=terraform/composants/01_bastion ${{ github.event.inputs.terraform_action }} -auto-approve -parallelism=1
      - name: Proxmox Clean Urgence (API Timeout)
        if: failure() 
        shell: bash
        run: |
          echo "ðŸš¨ Ã‰chec dÃ©tectÃ©. Nettoyage forcÃ© des verrous et arrÃªt des rÃ©sidus sur Proxmox..."
          
          echo "Nettoyage Node 1 (${{ vars.TF_IP_NODE_1 }}) - VM 401"
          ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_1 }} "qm unlock 401 || true; qm stop 401 || true"

          echo "Nettoyage Node 2 (${{ vars.TF_IP_NODE_2 }}) - VM 402"
          ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_2 }} "qm unlock 402 || true; qm stop 402 || true"
      # ==========================================
      # HEALTHCHECKS (Validation avant Ansible)
      # ==========================================
      - name: Validation rÃ©seau (Ping & SSH)
        if: |
          github.event.inputs.run_ansible == 'true' || 
          (github.event.inputs.run_terraform == 'true' && github.event.inputs.terraform_action == 'apply')
        run: |
          IP1="${{ vars.TF_IP_BASTION_01 }}"
          IP2="${{ vars.TF_IP_BASTION_02 }}"
          
          echo "Attente du rÃ©seau sur $IP1 et $IP2..."
          for IP in $IP1 $IP2; do
            timeout 180s bash -c "until ping -c 1 -W 1 $IP > /dev/null; do echo 'Waiting for $IP...'; sleep 5; done"
            echo "$IP rÃ©pond au ping."
            timeout 120s bash -c "until nc -zvw1 $IP 22; do sleep 5; done"
            echo "$IP est prÃªt pour SSH."
          done

      # ==========================================
      # SECTION ANSIBLE
      # ==========================================
      - name: Ansible Playbook (Bastion Setup)
        if: github.event.inputs.run_ansible == 'true'
        run: |
          ansible-playbook -i ansible/inventory/inventory.proxmox.yml \
          ansible/01_deploy_bastions.yml
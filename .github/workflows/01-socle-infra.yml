name: "01. Socle - Déploiement Bastion"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement (poc ou nuuk)"
        required: true
        type: choice
        options: [poc, nuuk]
      run_terraform:
        description: "Exécuter Terraform ?"
        type: boolean
        default: true
      terraform_action:
        description: "Action Terraform"
        type: choice
        options: [apply, plan, destroy]
        default: apply
      run_ansible:
        description: "Exécuter Ansible ?"
        type: boolean
        default: true

jobs:
  deploy:
    name: "Provisionnement & Configuration"
    runs-on: [self-hosted, poc-runner]
    environment: ${{ github.event.inputs.environment }}

    env:
      # --- TERRAFORM VARS ---
      TF_WORKSPACE: "nuuk-medilab-${{ github.event.inputs.environment }}-01-bastion"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      TF_CLOUD_ORGANIZATION: "nuuk"
      TF_VAR_environnement: ${{ github.event.inputs.environment }}
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_proxmox_api_user: ${{ secrets.PVE_API_USER }}
      TF_VAR_proxmox_api_token_id: ${{ secrets.PVE_TOKEN_ID }}
      TF_VAR_proxmox_api_token_secret: ${{ secrets.PVE_TOKEN_SECRET }}
      TF_VAR_ip_bastion_01: ${{ vars.TF_IP_BASTION_01 }}
      TF_VAR_ip_bastion_02: ${{ vars.TF_IP_BASTION_02 }}
      TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
      TF_VAR_gateway_vlan40: ${{ vars.TF_GATEWAY_VLAN40 }}
      TF_VAR_datastore_id: ${{ vars.TF_DATASTORE_ID }}
      TF_VAR_node_name_1: ${{ vars.TF_NAME_NODE_1 }}
      TF_VAR_node_name_2: ${{ vars.TF_NAME_NODE_2 }}
      TF_VAR_network_v1: ${{ vars.TF_NETWORK_V1 }}
      TF_VAR_ssh_public_keys: |
        ${{ vars.SSH_PUBLIC_KEYS }}
      
      # --- ANSIBLE / SHARED VARS ---
      BASTION_IFACE: ${{ vars.BASTION_IFACE }}
      BASTION_PASS: ${{ secrets.BASTION_PASS }}
      BASTION_ROUTER_ID: ${{ vars.BASTION_ROUTER_ID }}
      ANSIBLE_HOST_KEY_CHECKING: "False"

    steps:
      - uses: actions/checkout@v4

      # ==========================================
      # SECTION TERRAFORM
      # ==========================================
      - name: Setup Terraform
        if: github.event.inputs.run_terraform == 'true'
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        if: github.event.inputs.run_terraform == 'true'
        run: terraform -chdir=terraform/composants/01_bastion init

      - name: Terraform Action
        if: github.event.inputs.run_terraform == 'true'
        run: |
          terraform -chdir=terraform/composants/01_bastion ${{ github.event.inputs.terraform_action }} -auto-approve -parallelism=1

      # ==========================================
      # HEALTHCHECKS (Validation avant Ansible)
      # ==========================================
      - name: Validation réseau (Ping & SSH)
        if: |
          github.event.inputs.run_ansible == 'true' || 
          (github.event.inputs.run_terraform == 'true' && github.event.inputs.terraform_action == 'apply')
        run: |
          IP1="${{ vars.TF_IP_BASTION_01 }}"
          IP2="${{ vars.TF_IP_BASTION_02 }}"
          
          echo "Attente du réseau sur $IP1 et $IP2..."
          for IP in $IP1 $IP2; do
            timeout 180s bash -c "until ping -c 1 -W 1 $IP > /dev/null; do echo 'Waiting for $IP...'; sleep 5; done"
            echo "$IP répond au ping."
            timeout 120s bash -c "until nc -zvw1 $IP 22; do sleep 5; done"
            echo "$IP est prêt pour SSH."
          done

      # ==========================================
      # SECTION ANSIBLE
      # ==========================================
      - name: Python pour Ansible
        if: github.event.inputs.run_ansible == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Installation dépendences Ansible
        if: github.event.inputs.run_ansible == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install ansible-core community.proxmox

      - name: Ansible Playbook (Bastion Setup)
        if: github.event.inputs.run_ansible == 'true'
        run: |
          # On utilise l'inventaire dynamique pour cibler le groupe ROLE_BAST
          ansible-playbook -i ansible/inventory/inventory.proxmox.yml \
            ansible/playbooks/01_deploy_bastions.yml \
            -u cloudadm
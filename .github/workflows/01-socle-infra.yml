name: "01. Socle - Infrastructure"

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environnement (poc ou nuuk)"
        required: true
        type: choice
        options: [poc, nuuk]
        default: poc

      # --- CONTRÔLE TERRAFORM ---
      run_terraform:
        description: "Exécuter Terraform ?"
        type: boolean
        default: true
      terraform_action:
        description: "Action Terraform (apply/plan/destroy)"
        type: choice
        options: [apply, plan, destroy]
        default: apply

      # --- CONTRÔLE ANSIBLE ---
      run_ansible:
        description: "Exécuter Ansible ?"
        type: boolean
        default: true
      target_scope:
        description: "Composants à traiter"
        type: choice
        options: [Tous, Bastion, DHCP, Sélection]
        default: Tous

      # --- SÉLECTION MANUELLE (si Sélection choisie) ---
      deploy_bastion:
        description: "Cible : Bastion"
        type: boolean
        default: false
      deploy_dhcp:
        description: "Cible : DHCP"
        type: boolean
        default: false

jobs:
  deploy:
    name: "Provisionnement & Configuration"
    runs-on: [self-hosted, poc-runner]
    environment: ${{ github.event.inputs.environment }}

    env:
      # --- VARIABLES GLOBALES ---
      TF_CLOUD_ORGANIZATION: "nuuk"
      TF_TOKEN_app_terraform_io: ${{ secrets.TF_API_TOKEN }}
      ANSIBLE_CONFIG: "${{ github.workspace }}/ansible/ansible.cfg"
      BASTION_PASS: ${{ secrets.BASTION_PASS }}
      
      # --- TF_VARS ---
      TF_VAR_environnement: ${{ github.event.inputs.environment }}
      TF_VAR_proxmox_api_url: ${{ secrets.PVE_API_URL }}
      TF_VAR_proxmox_api_user: ${{ secrets.PVE_API_USER }}
      TF_VAR_proxmox_api_token_id: ${{ secrets.PVE_TOKEN_ID }}
      TF_VAR_proxmox_api_token_secret: ${{ secrets.PVE_TOKEN_SECRET }}
      TF_VAR_ssh_public_keys: "${{ vars.SSH_PUBLIC_KEYS }}"
      TF_VAR_ip_node_1: ${{ vars.TF_IP_NODE_1 }}
      TF_VAR_ip_node_2: ${{ vars.TF_IP_NODE_2 }}

    steps:
      - uses: actions/checkout@v4

      - name: SSH Agent Setup
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Setup Terraform
        if: github.event.inputs.run_terraform == 'true'
        uses: hashicorp/setup-terraform@v3

      # ==========================================
      # BLOC 01 : BASTION
      # ==========================================
      - name: "[TF] Bastion"
        if: |
          github.event.inputs.run_terraform == 'true' && 
          (github.event.inputs.target_scope == 'Tous' || github.event.inputs.target_scope == 'Bastion' || github.event.inputs.deploy_bastion == 'true')
        id: tf_bastion
        continue-on-error: false
        run: |
          export TF_WORKSPACE="nuuk-medilab-${{ github.event.inputs.environment }}-01-bastion"
          terraform -chdir=terraform/composants/01_bastion init
          terraform -chdir=terraform/composants/01_bastion ${{ github.event.inputs.terraform_action }} -auto-approve -parallelism=1

      - name: "[CLEAN] Proxmox Bastion (si fail)"
        if: failure() && steps.tf_bastion.outcome == 'failure'
        run: |
          for VMID in 401 402; do
            ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_1 }} "qm unlock $VMID || true"
            ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_2 }} "qm unlock $VMID || true"
          done

      - name: "[ANS] Config Bastion"
        if: |
          success() && github.event.inputs.run_ansible == 'true' && 
          (github.event.inputs.target_scope == 'Tous' || github.event.inputs.target_scope == 'Bastion' || github.event.inputs.deploy_bastion == 'true')
        run: |
          cd ansible
          ansible-playbook -i inventory/inventory.proxmox.yml 01_deploy_bastions.yml

      # ==========================================
      # BLOC 02 : CORE INFRA (DHCP)
      # ==========================================
      - name: "[TF] DHCP"
        if: |
          github.event.inputs.run_terraform == 'true' && 
          (github.event.inputs.target_scope == 'Tous' || github.event.inputs.target_scope == 'DHCP' || github.event.inputs.deploy_dhcp == 'true')
        id: tf_dhcp
        run: |
          export TF_WORKSPACE="nuuk-medilab-${{ github.event.inputs.environment }}-02-core-infra"
          terraform -chdir=terraform/composants/02_core_infra init
          terraform -chdir=terraform/composants/02_core_infra ${{ github.event.inputs.terraform_action }} -auto-approve -parallelism=1

      - name: "[CLEAN] Proxmox DHCP (si fail)"
        if: failure() && steps.tf_dhcp.outcome == 'failure'
        run: |
          for VMID in 701 702; do
            ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_1 }} "qm unlock $VMID || true"
            ssh -o StrictHostKeyChecking=no root@${{ vars.TF_IP_NODE_2 }} "qm unlock $VMID || true"
          done

      - name: "[ANS] Config DHCP"
        if: |
          success() && github.event.inputs.run_ansible == 'true' && 
          (github.event.inputs.target_scope == 'Tous' || github.event.inputs.target_scope == 'DHCP' || github.event.inputs.deploy_dhcp == 'true')
        env:
          TF_VAR_bastion_vip: ${{ vars.TF_IP_BASTION_VIP }}
          TF_VAR_ip_dhcp_vip: ${{ vars.TF_IP_DHCP_VIP }}
        run: |
          cd ansible
          ansible-playbook -i inventory/inventory.proxmox.yml 02_deploy_dhcp.yml